version: '3.8'

services:
  validator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.validator
    env_file:
      - ../.env
    environment:
      - WALLET_NAME=${WALLET_NAME:-validator}
      - WALLET_HOTKEY=${WALLET_HOTKEY:-default}
      - NETUID=${NETUID:-11}
      - NETWORK=${NETWORK:-finney}
      - CLAWBENCH_PATH=/clawbench
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - EPOCH_INTERVAL=${EPOCH_INTERVAL:-720}
    volumes:
      # ClawBench directory (from sibling repo)
      - ../../clawbench:/clawbench:ro
      # Bittensor wallet
      - ~/.bittensor:/root/.bittensor:ro
      # Logs
      - ../logs:/app/logs
      # Pack cache
      - pack-cache:/tmp/trajectoryrl_packs
    networks:
      - trajectoryrl-net
    depends_on:
      mock-tools:
        condition: service_healthy
      openclaw-gateway:
        condition: service_started

  # ClawBench mock tools server
  mock-tools:
    build:
      context: ../../clawbench
      dockerfile: Dockerfile.mock-tools
    environment:
      - FIXTURES_PATH=/app/fixtures
      - SCENARIO=${SCENARIO:-client_escalation}
    volumes:
      - ../../clawbench/fixtures:/app/fixtures:ro
      - ../../clawbench/clawbench:/app/clawbench:ro
    ports:
      - "3001:3001"
    networks:
      - trajectoryrl-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3001/health')"]
      interval: 5s
      timeout: 3s
      retries: 10

  # OpenClaw gateway (from sibling repo)
  openclaw-gateway:
    build:
      context: ../../openclaw
      dockerfile: Dockerfile.clawbench
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      # Workspace is dynamically created by validator during evaluation
      - workspace:/workspace
      # Config from ClawBench
      - ../../clawbench/config/openclaw.json:/app/config/openclaw.json:ro
    ports:
      - "18790:18790"
    networks:
      - trajectoryrl-net
    depends_on:
      mock-tools:
        condition: service_healthy

volumes:
  pack-cache:
  workspace:

networks:
  trajectoryrl-net:
    driver: bridge
