# Validate and auto-merge validator score submissions.
#
# Intended for the trajectoryRL/validator-scores repo.
# Validators submit scores via PR from their fork; this pipeline
# validates the payload and auto-merges if all checks pass.
#
# Reference: INCENTIVE_MECHANISM.md § Validator Consensus

name: Validate Score PR

on:
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

env:
  NETUID: "11"
  SUBTENSOR_NETWORK: finney

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest

    steps:
      # Checkout base branch (main) so we run the trusted validation script,
      # NOT code from the PR.
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Validate changed files
        id: check-files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES=$(gh pr diff "${{ github.event.pull_request.number }}" --name-only)
          FILE_COUNT=$(echo "$FILES" | grep -c .)

          if [ "$FILE_COUNT" -ne 1 ]; then
            echo "::error::PR must modify exactly one file (found $FILE_COUNT)"
            exit 1
          fi

          FILE=$(echo "$FILES" | head -1)
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

          if ! echo "$FILE" | grep -qE '^epoch-[0-9]+/[A-Za-z0-9]+\.json$'; then
            echo "::error::File must match pattern epoch-{N}/{hotkey}.json, got: $FILE"
            exit 1
          fi

          echo "Score file path: $FILE"

      # Fetch the score file content from the PR head (untrusted data, safe
      # because we only parse it as JSON with the trusted script).
      - name: Fetch score file from PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            "repos/${{ github.repository }}/contents/${{ steps.check-files.outputs.file }}?ref=${{ github.event.pull_request.head.sha }}" \
            --jq '.content' | base64 -d > /tmp/score_file.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-bittensor
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install "bittensor>=7.0.0"

      - name: Validate score file
        env:
          NETUID: ${{ env.NETUID }}
          SUBTENSOR_NETWORK: ${{ env.SUBTENSOR_NETWORK }}
        run: |
          python .github/scripts/validate_score_file.py \
            /tmp/score_file.json \
            "${{ steps.check-files.outputs.file }}"

      - name: Close PR on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr close "${{ github.event.pull_request.number }}" \
            --comment "**Score validation failed — PR closed.** Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."

      - name: Auto-merge PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "${{ github.event.pull_request.number }}" \
            --squash \
            --delete-branch \
            --admin
