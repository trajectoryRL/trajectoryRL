# TrajectoryRL — All-in-One Docker Compose
#
# Starts everything needed to run the validator:
#   docker compose up --watch       # auto-update on code changes
#   docker compose up -d            # or detached without auto-update
#   docker compose logs -f validator
#
# Services:
#   init          — Sets up workspace with default fixtures (runs once)
#   mock-tools    — Serves deterministic fixture data for scenarios
#   openclaw      — AI gateway that runs Claude with the pack's AGENTS.md
#   validator     — Queries miners, evaluates packs via ClawBench, sets weights
#   miner         — (optional) Serves a policy pack via Bittensor
#
# Required .env:
#   ANTHROPIC_API_KEY=sk-ant-...
#   WALLET_NAME=validator
#   WALLET_HOTKEY=default

services:
  # --------------------------------------------------------------------------
  # Init: populate /workspace with default scenario fixtures (runs once)
  # --------------------------------------------------------------------------
  init:
    build:
      context: ./clawbench
      dockerfile: Dockerfile.init
    container_name: trajectoryrl_init
    volumes:
      - ./clawbench/fixtures:/fixtures:ro
      - ./clawbench/scenarios:/scenarios:ro
      - workspace:/workspace
    environment:
      - SCENARIO=${SCENARIO:-client_escalation}
      - VARIANT=${VARIANT:-optimized}
    develop:
      watch:
        - action: rebuild
          path: ./clawbench/fixtures
        - action: rebuild
          path: ./clawbench/scenarios

  # --------------------------------------------------------------------------
  # Mock Tools: deterministic tool responses from fixtures (:3001)
  # --------------------------------------------------------------------------
  mock-tools:
    build:
      context: ./clawbench
      dockerfile: Dockerfile.mock-tools
    container_name: trajectoryrl_mock_tools
    restart: unless-stopped
    volumes:
      - ./clawbench/fixtures:/fixtures:ro
    environment:
      - FIXTURES_PATH=/fixtures
      - SCENARIO=${SCENARIO:-client_escalation}
    depends_on:
      init:
        condition: service_completed_successfully
    networks:
      - trajectoryrl
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3001/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
    develop:
      watch:
        - action: sync+restart
          path: ./clawbench/clawbench/mock_tools
          target: /app/mock_tools
          ignore:
            - __pycache__/
            - "*.pyc"
        - action: rebuild
          path: ./clawbench/requirements-mock.txt

  # --------------------------------------------------------------------------
  # OpenClaw: AI gateway — runs Claude with AGENTS.md from /workspace
  # --------------------------------------------------------------------------
  openclaw:
    build:
      context: ./openclaw
      dockerfile: Dockerfile.clawbench
    container_name: trajectoryrl_openclaw
    restart: unless-stopped
    volumes:
      - workspace:/workspace
      - ./clawbench/config/openclaw.json:/home/node/.openclaw/openclaw.json:ro
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-sandbox-token-12345}
      - CLAWBENCH_MODEL=${CLAWBENCH_MODEL:-anthropic/claude-sonnet-4-5-20250929}
    depends_on:
      init:
        condition: service_completed_successfully
      mock-tools:
        condition: service_healthy
    networks:
      - trajectoryrl
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # --------------------------------------------------------------------------
  # Validator: queries miners, evaluates packs, sets on-chain weights
  # --------------------------------------------------------------------------
  validator:
    build:
      context: .
      dockerfile: docker/Dockerfile.validator
    container_name: trajectoryrl_validator
    restart: unless-stopped
    environment:
      # Bittensor
      - WALLET_NAME=${WALLET_NAME:-validator}
      - WALLET_HOTKEY=${WALLET_HOTKEY:-default}
      - NETUID=${NETUID:-11}
      - NETWORK=${NETWORK:-finney}
      # ClawBench integration (wired to sibling services)
      - CLAWBENCH_PATH=/app/clawbench
      - MOCK_TOOLS_URL=http://mock-tools:3001
      - OPENCLAW_URL=http://openclaw:18789
      - WORKSPACE_PATH=/workspace
      # Evaluation (720s = 12min for local testing; production uses 86400s = 24h)
      - EPOCH_INTERVAL=${EPOCH_INTERVAL:-720}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # API keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Model
      - CLAWBENCH_MODEL=${CLAWBENCH_MODEL:-anthropic/claude-sonnet-4-5-20250929}
      # GitHub CLI auth (for score publishing)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets:ro
      - workspace:/workspace
      - ./logs:/app/logs
      - /tmp/trajectoryrl_packs:/tmp/trajectoryrl_packs
      - ./git_cache:/app/logs/git_cache
    depends_on:
      mock-tools:
        condition: service_healthy
    networks:
      - trajectoryrl
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    develop:
      watch:
        # Validator source code — sync + restart on changes
        - action: sync+restart
          path: ./trajectoryrl
          target: /app/trajectoryrl
          ignore:
            - __pycache__/
            - "*.pyc"
        # Neuron entry points
        - action: sync+restart
          path: ./neurons
          target: /app/neurons
          ignore:
            - __pycache__/
            - "*.pyc"
        # ClawBench scenarios, fixtures, and scoring
        - action: sync+restart
          path: ./clawbench
          target: /app/clawbench
          ignore:
            - __pycache__/
            - "*.pyc"
            - .git/
        # Dependency or Dockerfile changes — full rebuild
        - action: rebuild
          path: ./requirements.txt
        - action: rebuild
          path: ./pyproject.toml
        - action: rebuild
          path: ./docker/Dockerfile.validator

  # --------------------------------------------------------------------------
  # Miner (optional): start with `docker compose --profile miner up -d`
  # --------------------------------------------------------------------------
  miner:
    build:
      context: .
      dockerfile: docker/Dockerfile.miner
    container_name: trajectoryrl_miner
    restart: unless-stopped
    environment:
      - WALLET_NAME=${WALLET_NAME:-miner}
      - WALLET_HOTKEY=${WALLET_HOTKEY:-default}
      - NETUID=${NETUID:-11}
      - NETWORK=${NETWORK:-finney}
      - PACK_PATH=${PACK_PATH:-/app/packs/pack.json}
      - PACK_REPO=${PACK_REPO:-}
      - PACK_COMMIT=${PACK_COMMIT:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets:ro
      - ./packs:/app/packs:ro
      - ./logs:/app/logs
    networks:
      - trajectoryrl
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - miner

volumes:
  workspace:

networks:
  trajectoryrl:
    driver: bridge
